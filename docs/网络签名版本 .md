# 网络签名版本

## 前言

当前工具已支持使用本地证书、公钥、私钥的方式实现对 `.scrate` 格式文件的签名以及校验。

为了支持统一的签名管理平台，我们需要实现基于网络平台的签名和校验功能。网络签名版本将签名和验签操作委托给统一的 PKI 平台完成，提供更安全、更集中的密钥管理能力。

## 流程设计

### 总体流程

网络签名版本的整体流程如下：

#### 1. 密钥对管理

- **密钥对存储位置**：默认存储在 `config/keypair.bin` 文件中
- **密钥对获取**：如果本地不存在密钥对文件，需要从 PKI 平台获取新的密钥对
- **密钥对格式**：使用二进制格式（`.bin`）存储公钥和私钥

#### 2. 编码（Encode）流程

生成 `.scrate` 格式文件的流程：

1. 打包内容并计算摘要
2. 调用 PKI 平台的签名接口，使用私钥对摘要进行签名
3. 将公钥和签名写入 `.scrate` 文件的签名段
4. 输出完整的 `.scrate` 文件

#### 3. 解码（Decode）流程

验证并提取 `.scrate` 文件内容的流程：

1. 提取 `.scrate` 文件签名段中的签名和公钥
2. 计算文件内容的摘要
3. 将公钥、签名和计算的摘要发送到 PKI 平台进行统一验证
4. 验证通过后，提取并输出文件内容

## API 接口说明

### 获取密钥对

从 PKI 平台获取新的密钥对。

**接口信息：**

- **URL**: `https://signatom.xuanwu.openatom.cn/v1/keypair`
- **Method**: `POST`
- **Content-Type**: `application/json`
- **Accept**: `application/json`

**请求体：**

```json
{
  "algo": "sm2",
  "kms": "",
  "flow": "classic"
}
```

**响应体：**

```json
{
  "base_config": {
    "algo": "sm2",
    "kms": "",
    "flow": "classic"
  },
  "priv": "private key",
  "pub": "public key",
  "key_id": ""
}
```

**说明：**
- `algo`: 签名算法，当前支持 `sm2`
- `kms`: 密钥管理服务标识（可选）
- `flow`: 签名流程类型，当前使用 `classic`
- `priv`: 返回的私钥
- `pub`: 返回的公钥
- `key_id`: 密钥标识符

### 保存密钥对

获取密钥对后，需要将密钥对保存到本地：

- **存储路径**: `config/keypair.bin`
- **存储格式**: 二进制格式（`.bin`），包含公钥和私钥信息
- **用途**: 后续签名操作将使用本地保存的密钥对，避免重复从平台获取

### 密钥解析

提供密钥解析功能，支持从 `keypair.bin` 文件中提取：
- 公钥（用于验签）
- 私钥（用于签名）

## PKI 平台签名接口

在编码流程中，如果使用网络签名模式，需要调用 PKI 平台的签名接口生成签名。

**接口信息：**

- **URL**: `https://signatom.xuanwu.openatom.cn/v1/sign/digest`
- **Method**: `POST`
- **Content-Type**: `application/json`
- **Accept**: `application/json`

**请求体：**

```json
{
  "base_config": {
    "algo": "sm2",
    "flow": "classic"
  },
  "priv": "private key",
  "digest": "A string of digest"
}
```

**响应体：**

```json
{
  "base_config": {
    "algo": "sm2",
    "kms": "",
    "flow": "classic"
  },
  "signature": "content signature",
  "cert": ""
}
```

**说明：**
- `digest`: 待签名的摘要值（字符串格式）
- `priv`: 用于签名的私钥
- `signature`: 返回的签名值，将写入 `.scrate` 文件的签名段
- `cert`: 证书信息（可选）

## PKI 平台验签接口

在解码流程中，如果使用网络签名模式，需要调用 PKI 平台的验签接口验证签名。

**接口信息：**

- **URL**: `https://signatom.xuanwu.openatom.cn/v1/verify/digest`
- **Method**: `POST`
- **Content-Type**: `application/json`
- **Accept**: `application/json`

**请求体：**

```json
{
  "base_config": {
    "algo": "sm2",
    "flow": "classic"
  },
  "pub": "public key",
  "digest": "calculated digest",
  "signature": "extracted signature"
}
```

**响应体（验签成功）：**

```json
{
  "base_config": {
    "algo": "sm2",
    "kms": "",
    "flow": "classic"
  },
  "result": "OK"
}
```

**响应体（验签失败）：**

```json
{
  "base_config": {
    "algo": "sm2",
    "kms": "",
    "flow": "classic"
  },
  "result": "FAIL",
  "error": "error message"
}
```

**验签流程：**

1. 从 `.scrate` 文件签名段提取公钥和签名
2. 计算文件内容的摘要
3. 将公钥、摘要和签名发送到 PKI 平台
4. 根据平台返回结果判断：
   - `result: "OK"` → 验签成功，继续提取内容
   - `result: "FAIL"` → 验签失败，终止操作并报错

## 实现要点

### 密钥管理

- 密钥对优先从本地 `config/keypair.bin` 读取
- 本地不存在时，自动从 PKI 平台获取并保存
- 密钥对以二进制格式存储，确保安全性

### 签名流程

- 计算内容摘要后，调用 PKI 平台签名接口
- 将返回的签名和公钥写入 `.scrate` 文件签名段
- 确保签名段的格式符合规范

### 验签流程

- 提取签名段中的公钥和签名
- 重新计算内容摘要
- 调用 PKI 平台验签接口进行统一验证
- 只有验签成功才允许提取内容

## 注意事项

1. **网络连接**：网络签名模式需要确保能够访问 PKI 平台
2. **密钥安全**：本地存储的密钥对文件需要妥善保管
3. **错误处理**：需要妥善处理网络请求失败、平台返回错误等异常情况
4. **向后兼容**：网络签名版本应与本地签名版本保持兼容，支持两种模式切换
