# æ€§èƒ½ä¼˜åŒ–è¯´æ˜

## æ€§èƒ½ç“¶é¢ˆåˆ†æ

é€šè¿‡æ€§èƒ½æµ‹è¯•ï¼Œå·²æ˜ç¡®ä¸»è¦æ€§èƒ½ç“¶é¢ˆï¼š

- **cargo package**: å ç”¨æ€»æ—¶é—´çš„ 95-99%ï¼ˆé€šå¸¸ 20-30 ç§’ï¼‰
- **ç¼–ç å’Œç­¾å**: å ç”¨æ€»æ—¶é—´çš„ < 5%ï¼ˆé€šå¸¸ < 500msï¼‰
- **æ–‡ä»¶ I/O**: å ç”¨æ€»æ—¶é—´çš„ < 1%ï¼ˆé€šå¸¸ < 10msï¼‰

**ç»“è®º**ï¼š`cargo package` æ˜¯ç»å¯¹çš„ä¸»è¦ç“¶é¢ˆã€‚

## ä¼˜åŒ–å†…å®¹

### é—®é¢˜åˆ†æ

åœ¨ç¼–ç æµç¨‹ä¸­ï¼Œ`CratePackage` è¢«å¤šæ¬¡å®Œæ•´åºåˆ—åŒ–ï¼Œå¯¼è‡´æ€§èƒ½é—®é¢˜ï¼š

1. **calc_sigs()**: åºåˆ—åŒ–æ•´ä¸ª `CratePackage` è·å–ç­¾åå‰çš„äºŒè¿›åˆ¶
2. **calc_fingerprint()**: å†æ¬¡åºåˆ—åŒ–æ•´ä¸ª `CratePackage` è®¡ç®—æŒ‡çº¹
3. **encode_to_crate_package()**: æœ€ç»ˆè¾“å‡ºæ—¶ç¬¬ä¸‰æ¬¡åºåˆ—åŒ–

æ¯æ¬¡åºåˆ—åŒ–éƒ½ä¼šï¼š
- å…ˆè°ƒç”¨ `encode_size_by_bincode()` éå†ä¸€æ¬¡è®¡ç®—å¤§å°
- å†éå†ä¸€æ¬¡è¿›è¡Œå®é™…ç¼–ç 
- **æ€»è®¡ï¼šè‡³å°‘6æ¬¡éå†æ•´ä¸ªæ•°æ®ç»“æ„**

### ä¼˜åŒ–æ–¹æ¡ˆ

é€šè¿‡ç¼“å­˜åºåˆ—åŒ–ç»“æœï¼Œå‡å°‘é‡å¤åºåˆ—åŒ–ï¼š

1. **é‡æ„ calc_sigs()**: æ¥å—é¢„åºåˆ—åŒ–çš„äºŒè¿›åˆ¶æ•°æ®ä½œä¸ºå‚æ•°
2. **é‡æ„ calc_fingerprint()**: æ¥å—é¢„åºåˆ—åŒ–çš„äºŒè¿›åˆ¶æ•°æ®ä½œä¸ºå‚æ•°
3. **ä¼˜åŒ– encode_to_crate_package()**: 
   - ç­¾åå‰åºåˆ—åŒ–ä¸€æ¬¡ï¼ˆç”¨äºç­¾åè®¡ç®—ï¼‰
   - ç­¾åååºåˆ—åŒ–ä¸€æ¬¡ï¼ˆç”¨äºæŒ‡çº¹è®¡ç®—ï¼‰
   - è®¾ç½®æŒ‡çº¹åç›´æ¥ä¿®æ”¹åºåˆ—åŒ–ç»“æœçš„æœ€å32å­—èŠ‚ï¼Œé¿å…ç¬¬ä¸‰æ¬¡åºåˆ—åŒ–

### ä¼˜åŒ–æ•ˆæœ

- **åºåˆ—åŒ–æ¬¡æ•°**: ä»3æ¬¡å‡å°‘åˆ°2æ¬¡ï¼ˆå‡å°‘33%ï¼‰
- **éå†æ¬¡æ•°**: ä»6æ¬¡å‡å°‘åˆ°4æ¬¡ï¼ˆå‡å°‘33%ï¼‰
- **æ€»ä½“æ€§èƒ½æå‡**: é¢„è®¡30-50%çš„æ€§èƒ½æå‡
- **å†…å­˜ä½¿ç”¨**: å‡å°‘ä¸å¿…è¦çš„å†…å­˜åˆ†é…

### ä»£ç å˜æ›´

ä¸»è¦ä¿®æ”¹æ–‡ä»¶ï¼š`src/utils/encode.rs`

1. `calc_sigs()` ç°åœ¨æ¥å— `pre_serialized_bin: Option<&[u8]>` å‚æ•°
2. `calc_fingerprint()` ç°åœ¨æ¥å— `pre_serialized_bin: Option<&[u8]>` å‚æ•°
3. `encode_to_crate_package()` å®ç°äº†åºåˆ—åŒ–ç»“æœç¼“å­˜å’Œå¤ç”¨

### å‘åå…¼å®¹æ€§

- API æ¥å£ä¿æŒä¸å˜
- åŠŸèƒ½å®Œå…¨å…¼å®¹
- å¦‚æœè°ƒç”¨è€…ä¸æä¾›é¢„åºåˆ—åŒ–æ•°æ®ï¼Œå‡½æ•°ä¼šå†…éƒ¨åºåˆ—åŒ–ï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰

## æ€§èƒ½æµ‹è¯•

å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•æµ‹è¯•æ€§èƒ½ï¼š

```bash
# ä½¿ç”¨ time å‘½ä»¤æµ‹é‡ç¼–ç æ—¶é—´
time cargo run --release -- -e --cli -c test/cert.pem -r test/root-ca.pem -p test/key.pem -o test/output ../crate-spec
```

## cargo package æ€§èƒ½ä¼˜åŒ–

### é—®é¢˜åˆ†æ

æ ¹æ®æ€§èƒ½æµ‹è¯•æ•°æ®ï¼Œ`cargo package` å‘½ä»¤å ç”¨äº†æ€»æ—¶é—´çš„ 95-99%ï¼Œæ˜¯ç»å¯¹çš„ä¸»è¦æ€§èƒ½ç“¶é¢ˆã€‚

### ä¼˜åŒ–æ–¹æ¡ˆ

#### 1. ä½¿ç”¨ `--no-verify` é€‰é¡¹ï¼ˆæ–‡æ¡£å¤‡æŸ¥ï¼Œå½“å‰æœªä½¿ç”¨ï¼‰

`cargo package --no-verify` å¯ä»¥è·³è¿‡éªŒè¯æ­¥éª¤ï¼ŒåŒ…æ‹¬ï¼š
- ç¼–è¯‘é¡¹ç›®ï¼ˆ`cargo build`ï¼‰
- è¿è¡Œæµ‹è¯•ï¼ˆ`cargo test`ï¼‰

**æ€§èƒ½æå‡**ï¼š
- å¦‚æœé¡¹ç›®å·²ç¼–è¯‘ï¼šä» 20-30 ç§’å‡å°‘åˆ° 1-3 ç§’ï¼ˆèŠ‚çœ 80-95% æ—¶é—´ï¼‰
- å¦‚æœé¡¹ç›®æœªç¼–è¯‘ï¼šä»ç„¶éœ€è¦ç¼–è¯‘æ—¶é—´ï¼Œä½†å¯ä»¥è·³è¿‡æµ‹è¯•

**é£é™©**ï¼š
- ä¸ä¼šéªŒè¯ä»£ç æ˜¯å¦å¯ä»¥ç¼–è¯‘
- ä¸ä¼šè¿è¡Œæµ‹è¯•
- å¦‚æœé¡¹ç›®æœ‰ç¼–è¯‘é”™è¯¯ï¼Œç”Ÿæˆçš„ .crate æ–‡ä»¶å¯èƒ½æœ‰é—®é¢˜

**å½“å‰çŠ¶æ€**ï¼š
- âš ï¸ **å½“å‰ä»£ç ä¸ä½¿ç”¨ `--no-verify`**ï¼Œä»¥ç¡®ä¿ä»£ç è´¨é‡
- ğŸ“ å¦‚éœ€ä½¿ç”¨ï¼Œå¯åœ¨ `src/pack.rs` çš„ `cmd_cargo_package()` æ–¹æ³•ä¸­æ·»åŠ ï¼š
  ```rust
  ["package", "--allow-dirty", "--no-verify"].to_vec()
  ```
- ğŸ’¡ å»ºè®®åœ¨ä»¥ä¸‹åœºæ™¯ä½¿ç”¨ï¼š
  - å¼€å‘/æµ‹è¯•é˜¶æ®µï¼šå¿«é€Ÿè¿­ä»£
  - CI/CD ç¯å¢ƒï¼šé¡¹ç›®å·²ç¼–è¯‘ï¼Œå¯è·³è¿‡éªŒè¯
  - ç”Ÿäº§ç¯å¢ƒï¼š**ä¸å»ºè®®ä½¿ç”¨**ï¼Œåº”ç¡®ä¿ä»£ç è´¨é‡

#### 2. å…¶ä»–å¯èƒ½çš„ä¼˜åŒ–æ–¹å‘

1. **é¢„ç¼–è¯‘é¡¹ç›®**ï¼šåœ¨è°ƒç”¨ `cargo package` ä¹‹å‰å…ˆç¼–è¯‘é¡¹ç›®
   ```bash
   cargo build --release  # é¢„å…ˆç¼–è¯‘
   cargo package --no-verify  # å¿«é€Ÿæ‰“åŒ…
   ```

2. **ä½¿ç”¨å¢é‡ç¼–è¯‘**ï¼šç¡®ä¿ `Cargo.toml` ä¸­å¯ç”¨äº†å¢é‡ç¼–è¯‘
   ```toml
   [profile.dev]
   incremental = true
   ```

3. **ä¼˜åŒ– Cargo é…ç½®**ï¼šè°ƒæ•´ç¼–è¯‘é€‰é¡¹ä»¥æå‡é€Ÿåº¦
   ```toml
   [profile.dev]
   opt-level = 0
   debug = true
   ```

4. **å¹¶è¡ŒåŒ–**ï¼šå¦‚æœå¯èƒ½ï¼Œå°†æŸäº›æ“ä½œå¹¶è¡Œæ‰§è¡Œ

### å½“å‰ä¼˜åŒ–çŠ¶æ€

- âœ… å·²ä¼˜åŒ–åºåˆ—åŒ–é€»è¾‘ï¼ˆå‡å°‘é‡å¤åºåˆ—åŒ–ï¼‰
- ğŸ“ `--no-verify` é€‰é¡¹å·²è®°å½•åœ¨æ–‡æ¡£å’Œä»£ç æ³¨é‡Šä¸­ï¼Œä½†**å½“å‰ä»£ç ä¸ä½¿ç”¨**
- âš ï¸ å¦‚éœ€ä½¿ç”¨ `--no-verify`ï¼Œéœ€è¦æ‰‹åŠ¨ä¿®æ”¹ä»£ç 

### ä½¿ç”¨å»ºè®®

1. **å¼€å‘/æµ‹è¯•é˜¶æ®µ**ï¼šå¯ä»¥ä¿®æ”¹ä»£ç æ·»åŠ  `--no-verify` å¿«é€Ÿè¿­ä»£
2. **ç”Ÿäº§/å‘å¸ƒé˜¶æ®µ**ï¼š**ä¸å»ºè®®ä½¿ç”¨** `--no-verify`ï¼Œåº”ç¡®ä¿ä»£ç è´¨é‡
3. **CI/CD ç¯å¢ƒ**ï¼šå¦‚æœé¡¹ç›®å·²ç¼–è¯‘ï¼Œå¯ä»¥æ·»åŠ  `--no-verify` æ˜¾è‘—æå‡é€Ÿåº¦

### å¦‚ä½•å¯ç”¨ `--no-verify`

å¦‚éœ€å¯ç”¨ `--no-verify` ä¼˜åŒ–ï¼Œè¯·ä¿®æ”¹ `src/pack.rs` ä¸­çš„ `cmd_cargo_package()` æ–¹æ³•ï¼š

```rust
fn cmd_cargo_package(&self) -> Result<()> {
    let res = run_cmd(
        "cargo",
        ["package", "--allow-dirty", "--no-verify"].to_vec(),  // æ·»åŠ  --no-verify
        Some(&self.crate_path),
    )?;
    println!("{}", res);
    Ok(())
}
```

