# crate-spec é¡¹ç›®æ¦‚è§ˆ

**crate-spec** æ˜¯ä¸€ä¸ª Rust å·¥å…·ï¼Œç”¨äºç”Ÿæˆå’ŒéªŒè¯ `.scrate` æ–‡ä»¶ã€‚è¯¥æ ¼å¼åœ¨æ ‡å‡† `.crate` åŸºç¡€ä¸Šå¢åŠ äº†ç­¾åå’Œå®Œæ•´æ€§æ ¡éªŒï¼Œæ”¯æŒé•œåƒ/ç¼“å­˜åœºæ™¯ä¸‹çš„ç«¯åˆ°ç«¯æ•°æ®å®Œæ•´æ€§ä¸è®¤è¯ã€‚

---

## ğŸ“‘ ç›®å½•

- [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
  - [ç›®å½•ç»„ç»‡](#ç›®å½•ç»„ç»‡)
- [æ ¸å¿ƒæ¨¡å—åˆ†æ](#æ ¸å¿ƒæ¨¡å—åˆ†æ)
  - [1. äºŒè¿›åˆ¶æ ¼å¼](#1-äºŒè¿›åˆ¶æ ¼å¼-srcutilspackage)
  - [2. åŒ…ä¸Šä¸‹æ–‡](#2-åŒ…ä¸Šä¸‹æ–‡-srcutilscontextrs)
  - [3. ç¼–ç æµç¨‹](#3-ç¼–ç æµç¨‹-srcutilsencoders)
  - [4. è§£ç æµç¨‹](#4-è§£ç æµç¨‹-srcutilsdecoders)
  - [5. PKCS7 ç­¾å](#5-pkcs7-ç­¾å-srcutilspkcsrs)
  - [6. TOML è§£æ](#6-toml-è§£æ-srcutilsfrom_tomlrs)
  - [7. æ‰“åŒ…é€»è¾‘](#7-æ‰“åŒ…é€»è¾‘-srcpackrs)
  - [8. è§£åŒ…é€»è¾‘](#8-è§£åŒ…é€»è¾‘-srcunpackrs)
  - [9. å‘½ä»¤è¡Œæ¥å£](#9-å‘½ä»¤è¡Œæ¥å£-srcmainrs)
- [æ‰§è¡Œæµç¨‹](#æ‰§è¡Œæµç¨‹)
  - [ç¼–ç æµç¨‹ï¼ˆç”Ÿæˆ .scrateï¼‰](#ç¼–ç æµç¨‹ç”Ÿæˆ-scrate)
  - [è§£ç æµç¨‹ï¼ˆéªŒè¯å¹¶æå– .crateï¼‰](#è§£ç æµç¨‹éªŒè¯å¹¶æå–-crate)
- [å®‰å…¨æœºåˆ¶](#å®‰å…¨æœºåˆ¶)
- [è®¾è®¡ç‰¹ç‚¹](#è®¾è®¡ç‰¹ç‚¹)
- [ä½¿ç”¨è¯´æ˜](#ä½¿ç”¨è¯´æ˜)
- [åŠŸèƒ½éªŒè¯](#åŠŸèƒ½éªŒè¯)

---

## é¡¹ç›®ç»“æ„

### ç›®å½•ç»„ç»‡

```
crate-spec/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.rs          # å‘½ä»¤è¡Œå…¥å£
â”‚   â”œâ”€â”€ lib.rs           # åº“å…¥å£
â”‚   â”œâ”€â”€ pack.rs          # æ‰“åŒ…ï¼ˆç¼–ç ï¼‰é€»è¾‘
â”‚   â”œâ”€â”€ unpack.rs        # è§£åŒ…ï¼ˆè§£ç ï¼‰é€»è¾‘
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ mod.rs       # å·¥å…·æ¨¡å—å¯¼å‡º
â”‚       â”œâ”€â”€ context.rs   # åŒ…ä¸Šä¸‹æ–‡æ•°æ®ç»“æ„
â”‚       â”œâ”€â”€ encode.rs    # ç¼–ç å®ç°
â”‚       â”œâ”€â”€ decode.rs    # è§£ç å®ç°
â”‚       â”œâ”€â”€ from_toml.rs # TOMLè§£æå™¨
â”‚       â”œâ”€â”€ pkcs.rs      # PKCS7ç­¾å/éªŒè¯
â”‚       â””â”€â”€ package/     # äºŒè¿›åˆ¶æ ¼å¼å®šä¹‰
â”‚           â”œâ”€â”€ mod.rs   # åŒ…ç»“æ„å®šä¹‰
â”‚           â”œâ”€â”€ bin.rs   # ç¼–ç /è§£ç trait
â”‚           â””â”€â”€ gen_bincode.rs # Bincodeåºåˆ—åŒ–å®ç°
â”œâ”€â”€ test/                # æµ‹è¯•æ–‡ä»¶
â”‚   â”œâ”€â”€ example/         # ç¤ºä¾‹è„šæœ¬
â”‚   â””â”€â”€ test.toml        # æµ‹è¯•ç”¨çš„TOMLæ–‡ä»¶
â”œâ”€â”€ Cargo.toml           # é¡¹ç›®é…ç½®
â””â”€â”€ README.md            # é¡¹ç›®æ–‡æ¡£
```

---

## æ ¸å¿ƒæ¨¡å—åˆ†æ

### 1. äºŒè¿›åˆ¶æ ¼å¼ (`src/utils/package/`)

`.scrate` æ–‡ä»¶ç»“æ„ï¼š

```
+-------------------+
| Magic Number      | 5å­—èŠ‚: [0x43, 0x52, 0x41, 0x54, 0x45] ("CRATE")
+-------------------+
| CrateHeader       | ç‰ˆæœ¬ã€åç§»é‡ã€å¤§å°ä¿¡æ¯
+-------------------+
| StringTable       | å­—ç¬¦ä¸²è¡¨ï¼ˆå»é‡ï¼Œç”¨åç§»é‡å¼•ç”¨ï¼‰
+-------------------+
| SectionIndex      | æ®µç´¢å¼•è¡¨ï¼ˆæŒ‡å‘å„ä¸ªæ•°æ®æ®µï¼‰
+-------------------+
| DataSections      | æ•°æ®æ®µé›†åˆ
|   - PackageSection      (ç±»å‹0) åŒ…ä¿¡æ¯
|   - DepTableSection     (ç±»å‹1) ä¾èµ–è¡¨
|   - CrateBinarySection  (ç±»å‹3) åŸå§‹.crateäºŒè¿›åˆ¶
|   - SigStructureSection (ç±»å‹4) ç­¾åç»“æ„ï¼ˆå¯å¤šä¸ªï¼‰
+-------------------+
| Fingerprint       | 32å­—èŠ‚SHA256æŒ‡çº¹ï¼ˆæ–‡ä»¶æœ«å°¾ï¼‰
+-------------------+
```

**å…³é”®æ•°æ®ç»“æ„ï¼š**
- `CratePackage`: é¡¶å±‚ç»“æ„
- `CrateHeader`: æ–‡ä»¶å¤´ï¼ŒåŒ…å«å„æ®µåç§»å’Œå¤§å°
- `SectionIndex`: æ®µç´¢å¼•
- `DataSection`: æšä¸¾ï¼ŒåŒ…å«å››ç§æ•°æ®æ®µç±»å‹
- `StringTable`: å­—ç¬¦ä¸²å»é‡è¡¨

**ç›¸å…³æ–‡ä»¶ï¼š**
- [`src/utils/package/mod.rs`](src/utils/package/mod.rs) - æ•°æ®ç»“æ„å®šä¹‰
- [`src/utils/package/gen_bincode.rs`](src/utils/package/gen_bincode.rs) - åºåˆ—åŒ–å®ç°
- [`src/utils/package/bin.rs`](src/utils/package/bin.rs) - ç¼–ç /è§£ç trait

---

### 2. åŒ…ä¸Šä¸‹æ–‡ (`src/utils/context.rs`)

`PackageContext` æ˜¯æ ¸å¿ƒæ•°æ®ç»“æ„ï¼ŒåŒ…å«ï¼š

- `pack_info`: åŒ…ä¿¡æ¯ï¼ˆåç§°ã€ç‰ˆæœ¬ã€è®¸å¯è¯ã€ä½œè€…ï¼‰
- `dep_infos`: ä¾èµ–ä¿¡æ¯åˆ—è¡¨
- `crate_binary`: åŸå§‹ `.crate` æ–‡ä»¶äºŒè¿›åˆ¶
- `sigs`: ç­¾åä¿¡æ¯åˆ—è¡¨
- `root_cas`: æ ¹CAè¯ä¹¦åˆ—è¡¨ï¼ˆç”¨äºéªŒè¯ï¼‰

æ—¥å¸¸é€»è¾‘å¤„ç†ä¾èµ–äºè¿™ä¸ªç»“æ„ã€‚




### 3. ç¼–ç æµç¨‹ (`src/utils/encode.rs`)

ç¼–ç åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š

#### é˜¶æ®µ1ï¼šç­¾åå‰å‡†å¤‡
```rust
encode_to_crate_package_before_sig()
```
- è®¾ç½®é­”æ•°
- å†™å…¥åŒ…ä¿¡æ¯ã€ä¾èµ–è¡¨ã€crateäºŒè¿›åˆ¶
- å†™å…¥å ä½ç­¾åæ®µï¼ˆå…¨0ï¼‰
- æ„å»ºæ®µç´¢å¼•å’Œå­—ç¬¦ä¸²è¡¨
- è®¾ç½®æ–‡ä»¶å¤´

#### é˜¶æ®µ2ï¼šè®¡ç®—ç­¾å
```rust
encode_sig_to_crate_package()
```
- è®¡ç®—æ¯ä¸ªç­¾åçš„æ‘˜è¦ï¼ˆSHA256ï¼‰
- ä½¿ç”¨PKCS7å¯¹æ‘˜è¦ç­¾å
- æ›¿æ¢å ä½ç­¾åæ®µ

#### é˜¶æ®µ3ï¼šç­¾ååå¤„ç†
```rust
encode_to_crate_package_after_sig()
```
- æ›´æ–°æ®µç´¢å¼•å’Œæ–‡ä»¶å¤´
- è®¡ç®—æŒ‡çº¹ï¼ˆSHA256ï¼Œæ’é™¤æœ«å°¾32å­—èŠ‚ï¼‰
- å°†æŒ‡çº¹å†™å…¥æ–‡ä»¶æœ«å°¾

**ç›¸å…³æ–‡ä»¶ï¼š**
- [`src/utils/encode.rs:173`](src/utils/encode.rs#L173) - ç¼–ç ä¸»å‡½æ•°
- [`src/utils/encode.rs:115`](src/utils/encode.rs#L115) - ç­¾åè®¡ç®—

---

### 4. è§£ç æµç¨‹ (`src/utils/decode.rs`)

è§£ç æ­¥éª¤ï¼š

1. **æŒ‡çº¹éªŒè¯**
   ```rust
   check_fingerprint()
   ```
   - è®¡ç®—æ–‡ä»¶ï¼ˆé™¤æœ«å°¾32å­—èŠ‚ï¼‰çš„SHA256
   - ä¸æ–‡ä»¶æœ«å°¾æŒ‡çº¹æ¯”å¯¹

2. **è§£æäºŒè¿›åˆ¶ç»“æ„**
   - è§£æ `CratePackage`
   - è¯»å–å­—ç¬¦ä¸²è¡¨
   - è§£æå„æ•°æ®æ®µ

3. **ç­¾åéªŒè¯**
   ```rust
   check_sigs()
   ```
   - æ ¹æ®ç­¾åç±»å‹è®¡ç®—å®é™…æ‘˜è¦
   - ä½¿ç”¨æ ¹CAéªŒè¯PKCS7ç­¾å
   - æ¯”å¯¹æ‘˜è¦

4. **æå–æ•°æ®**
   - æ¢å¤åŒ…ä¿¡æ¯ã€ä¾èµ–ã€crateäºŒè¿›åˆ¶

**ç›¸å…³æ–‡ä»¶ï¼š**
- [`src/utils/decode.rs:154`](src/utils/decode.rs#L154) - è§£ç ä¸»å‡½æ•°
- [`src/utils/decode.rs:129`](src/utils/decode.rs#L129) - ç­¾åéªŒè¯

---

### 5. PKCS7 ç­¾å (`src/utils/pkcs.rs`)

`PKCS` å°è£…ç­¾åä¸éªŒè¯ï¼š

- `encode_pkcs_bin()`: å¯¹æ¶ˆæ¯æ‘˜è¦è¿›è¡ŒPKCS7ç­¾å
- `decode_pkcs_bin()`: éªŒè¯PKCS7ç­¾åå¹¶æå–åŸå§‹æ‘˜è¦
- `gen_digest_256()`: SHA256æ‘˜è¦

**ç›¸å…³æ–‡ä»¶ï¼š**
- [`src/utils/pkcs.rs`](src/utils/pkcs.rs) - PKCS7å®ç°

---

### 6. TOML è§£æ (`src/utils/from_toml.rs`)

`CrateToml` ä» `Cargo.toml` æå–ï¼š

- åŒ…ä¿¡æ¯ï¼ˆname, version, license, authorsï¼‰
- ä¾èµ–ä¿¡æ¯ï¼ˆname, version, source type, platformï¼‰

**æ”¯æŒçš„ä¾èµ–æºç±»å‹ï¼š**
- `CratesIo`: crates.io
- `Git`: Gitä»“åº“
- `Url`: URL
- `Registry`: è‡ªå®šä¹‰æ³¨å†Œè¡¨
- `P2p`: P2Pæº

**ç›¸å…³æ–‡ä»¶ï¼š**
- [`src/utils/from_toml.rs`](src/utils/from_toml.rs) - TOMLè§£æå™¨

---

### 7. æ‰“åŒ…é€»è¾‘ (`src/pack.rs`)

`Packing` ç»“æ„ä½“å¤„ç†æ‰“åŒ…ï¼š

1. `cmd_cargo_package()`: è°ƒç”¨ `cargo package --allow-dirty`
2. `read_crate()`:
   - è§£æ `Cargo.toml`
   - è¯»å–ç”Ÿæˆçš„ `.crate` æ–‡ä»¶
   - æ„å»º `PackageContext`

**ç›¸å…³æ–‡ä»¶ï¼š**
- [`src/pack.rs:84`](src/pack.rs#L84) - æ‰“åŒ…å…¥å£å‡½æ•°

---

### 8. è§£åŒ…é€»è¾‘ (`src/unpack.rs`)

`Unpacking` ç»“æ„ä½“å¤„ç†è§£åŒ…ï¼š

- åŠ è½½æ ¹CAè¯ä¹¦
- è°ƒç”¨ `PackageContext::decode_from_crate_package()` è§£ç 
- è¿”å›éªŒè¯åçš„ `PackageContext`

**ç›¸å…³æ–‡ä»¶ï¼š**
- [`src/unpack.rs:35`](src/unpack.rs#L35) - è§£åŒ…å…¥å£å‡½æ•°

---

### 9. å‘½ä»¤è¡Œæ¥å£ (`src/main.rs`)

ä½¿ç”¨ `clap` è§£æå‘½ä»¤è¡Œå‚æ•°ï¼š

**ç¼–ç æ¨¡å¼ (`-e`):**
- `-r`: æ ¹CAæ–‡ä»¶è·¯å¾„ï¼ˆå¯å¤šä¸ªï¼‰
- `-c`: å‘å¸ƒè€…è¯ä¹¦è·¯å¾„
- `-p`: å‘å¸ƒè€…ç§é’¥è·¯å¾„
- `-o`: è¾“å‡ºç›®å½•
- `<project path>`: Rusté¡¹ç›®è·¯å¾„

**è§£ç æ¨¡å¼ (`-d`):**
- `-r`: æ ¹CAæ–‡ä»¶è·¯å¾„ï¼ˆå¯å¤šä¸ªï¼‰
- `-o`: è¾“å‡ºç›®å½•
- `<.scrate file path>`: `.scrate` æ–‡ä»¶è·¯å¾„

**ç›¸å…³æ–‡ä»¶ï¼š**
- [`src/main.rs:38`](src/main.rs#L38) - å‘½ä»¤è¡Œå…¥å£

---

## æ‰§è¡Œæµç¨‹

### ç¼–ç æµç¨‹ï¼ˆç”Ÿæˆ .scrateï¼‰

```
1. è§£æå‘½ä»¤è¡Œå‚æ•°
   â†“
2. éªŒè¯å¿…éœ€å‚æ•°ï¼ˆè¯ä¹¦ã€ç§é’¥ã€æ ¹CAï¼‰
   â†“
3. pack_context() - æ‰“åŒ…ä¸Šä¸‹æ–‡
   â”œâ”€ è°ƒç”¨ cargo package
   â”œâ”€ è§£æ Cargo.toml
   â””â”€ è¯»å–ç”Ÿæˆçš„ .crate æ–‡ä»¶
   â†“
4. åŠ è½½PKCSç­¾åå™¨
   â”œâ”€ åŠ è½½è¯ä¹¦
   â”œâ”€ åŠ è½½ç§é’¥
   â””â”€ åŠ è½½æ ¹CA
   â†“
5. æ·»åŠ ç­¾ååˆ°PackageContext
   â†“
6. encode_to_crate_package() - ç¼–ç 
   â”œâ”€ é˜¶æ®µ1: ç­¾åå‰å‡†å¤‡ï¼ˆå†™å…¥æ•°æ®ï¼Œå ä½ç­¾åï¼‰
   â”œâ”€ é˜¶æ®µ2: è®¡ç®—å¹¶å†™å…¥çœŸå®ç­¾å
   â””â”€ é˜¶æ®µ3: è®¡ç®—å¹¶å†™å…¥æŒ‡çº¹
   â†“
7. å†™å…¥ .scrate æ–‡ä»¶åˆ°è¾“å‡ºç›®å½•
```


---

### è§£ç æµç¨‹ï¼ˆéªŒè¯å¹¶æå– .crateï¼‰

```
1. è§£æå‘½ä»¤è¡Œå‚æ•°
   â†“
2. éªŒè¯å¿…éœ€å‚æ•°ï¼ˆæ ¹CAï¼‰
   â†“
3. è¯»å– .scrate æ–‡ä»¶äºŒè¿›åˆ¶
   â†“
4. unpack_context() - è§£åŒ…ä¸Šä¸‹æ–‡
   â”œâ”€ åŠ è½½æ ¹CAè¯ä¹¦
   â””â”€ decode_from_crate_package() - è§£ç 
       â”œâ”€ éªŒè¯æŒ‡çº¹ï¼ˆå®Œæ•´æ€§æ£€æŸ¥ï¼‰
       â”œâ”€ è§£æäºŒè¿›åˆ¶ç»“æ„
       â”œâ”€ éªŒè¯ç­¾åï¼ˆèº«ä»½éªŒè¯ï¼‰
       â””â”€ æå–æ•°æ®åˆ°PackageContext
   â†“
5. æå– .crate æ–‡ä»¶åˆ°è¾“å‡ºç›®å½•
   â†“
6. å¯¼å‡ºå…ƒæ•°æ®åˆ° {name}-{version}-metadata.txt
```


## å®‰å…¨æœºåˆ¶

### å®Œæ•´æ€§ä¿æŠ¤
- æ–‡ä»¶æœ«å°¾32å­—èŠ‚SHA256æŒ‡çº¹
- ä¼ è¾“æˆ–å­˜å‚¨é”™è¯¯ä¼šè¢«æ£€æµ‹

### èº«ä»½è®¤è¯
- PKCS7æ•°å­—ç­¾å
- æ ¹CAè¯ä¹¦é“¾éªŒè¯
- æ”¯æŒå¯¹æ–‡ä»¶æˆ–ä»…å¯¹crateäºŒè¿›åˆ¶ç­¾å

### ç­¾åçµæ´»æ€§
- æ”¯æŒå¤šä¸ªç­¾å
- ä¸¤ç§ç­¾åç±»å‹ï¼ˆæ–‡ä»¶çº§/äºŒè¿›åˆ¶çº§ï¼‰

---

## è®¾è®¡ç‰¹ç‚¹

1. **è‡ªå®šä¹‰äºŒè¿›åˆ¶æ ¼å¼**ï¼šç´§å‡‘ä¸”å¯æ‰©å±•
2. **å­—ç¬¦ä¸²è¡¨å»é‡**ï¼šå‡å°‘æ–‡ä»¶å¤§å°
3. **æ®µç´¢å¼•**ï¼šæ”¯æŒéšæœºè®¿é—®
4. **å¤šé˜¶æ®µç¼–ç **ï¼šå…ˆå ä½å†ç­¾åï¼Œæœ€åè®¡ç®—æŒ‡çº¹
5. **åˆ†å±‚éªŒè¯**ï¼šæŒ‡çº¹æ£€æŸ¥å®Œæ•´æ€§ï¼Œç­¾åéªŒè¯èº«ä»½

---

## ä½¿ç”¨è¯´æ˜

### ç¼–ç ï¼ˆç”Ÿæˆ .scrate æ–‡ä»¶ï¼‰

ä½¿ç”¨ `-e` é€‰é¡¹å°† Rust é¡¹ç›®ç¼–ç ä¸º `.scrate` æ–‡ä»¶ã€‚

**å¿…éœ€å‚æ•°ï¼š**
- `-e`: å¯ç”¨ç¼–ç æ¨¡å¼
- `-r <root-ca.pem>`: æ ¹CAè¯ä¹¦æ–‡ä»¶è·¯å¾„ï¼ˆå¯æŒ‡å®šå¤šä¸ªï¼Œä½¿ç”¨å¤šä¸ª `-r`ï¼‰
- `-c <cert.pem>`: å‘å¸ƒè€…è¯ä¹¦æ–‡ä»¶è·¯å¾„
- `-p <key.pem>`: å‘å¸ƒè€…ç§é’¥æ–‡ä»¶è·¯å¾„
- `-o <output_dir>`: è¾“å‡ºç›®å½•è·¯å¾„
- `<project_path>`: è¦ç¼–ç çš„ Rust é¡¹ç›®è·¯å¾„

**ç¤ºä¾‹ï¼š**
```bash
crate-spec -e \
           -r test/root-ca.pem \
           -c test/cert.pem \
           -p test/key.pem \
           -o test/output \
           /path/to/rust-project
```

**åŠŸèƒ½è¯´æ˜ï¼š**
1. è‡ªåŠ¨è°ƒç”¨ `cargo package --allow-dirty` æ‰“åŒ…é¡¹ç›®
2. è§£æ `Cargo.toml` æå–åŒ…ä¿¡æ¯å’Œä¾èµ–ä¿¡æ¯
3. è¯»å–ç”Ÿæˆçš„ `.crate` æ–‡ä»¶
4. ä½¿ç”¨æä¾›çš„è¯ä¹¦å’Œç§é’¥å¯¹åŒ…è¿›è¡Œ PKCS7 ç­¾å
5. ç”Ÿæˆå¸¦ç­¾åçš„ `.scrate` æ–‡ä»¶å¹¶ä¿å­˜åˆ°è¾“å‡ºç›®å½•

---

### è§£ç ï¼ˆéªŒè¯å¹¶æå– .crate æ–‡ä»¶ï¼‰

ä½¿ç”¨ `-d` é€‰é¡¹è§£ç  `.scrate` æ–‡ä»¶ï¼ŒéªŒè¯å…¶å®Œæ•´æ€§å’Œæ¥æºã€‚

**å¿…éœ€å‚æ•°ï¼š**
- `-d`: å¯ç”¨è§£ç æ¨¡å¼
- `-r <root-ca.pem>`: æ ¹CAè¯ä¹¦æ–‡ä»¶è·¯å¾„ï¼ˆå¯æŒ‡å®šå¤šä¸ªï¼Œä½¿ç”¨å¤šä¸ª `-r`ï¼‰
- `-o <output_dir>`: è¾“å‡ºç›®å½•è·¯å¾„
- `<scrate_file>`: è¦è§£ç çš„ `.scrate` æ–‡ä»¶è·¯å¾„

**ç¤ºä¾‹ï¼š**
```bash
crate-spec -d \
           -r test/root-ca.pem \
           -o test/output \
           test/output/crate-spec-0.1.0.scrate
```

**åŠŸèƒ½è¯´æ˜ï¼š**
1. è¯»å– `.scrate` æ–‡ä»¶äºŒè¿›åˆ¶æ•°æ®
2. éªŒè¯æ–‡ä»¶æŒ‡çº¹ï¼ˆSHA256ï¼Œæ£€æŸ¥æ–‡ä»¶å®Œæ•´æ€§ï¼‰
3. è§£æäºŒè¿›åˆ¶ç»“æ„ï¼Œæå–åŒ…ä¿¡æ¯ã€ä¾èµ–ä¿¡æ¯
4. éªŒè¯ PKCS7 æ•°å­—ç­¾åï¼ˆéªŒè¯å‘å¸ƒè€…èº«ä»½ï¼‰
5. æå–åŸå§‹ `.crate` æ–‡ä»¶åˆ°è¾“å‡ºç›®å½•
6. å¯¼å‡ºåŒ…å…ƒæ•°æ®åˆ° `{name}-{version}-metadata.txt` æ–‡ä»¶

**è¾“å‡ºæ–‡ä»¶ï¼š**
- `{name}-{version}.crate`: åŸå§‹ crate æ–‡ä»¶
- `{name}-{version}-metadata.txt`: åŒ…å…ƒæ•°æ®ï¼ˆåŒ…å«åŒ…ä¿¡æ¯å’Œä¾èµ–ä¿¡æ¯ï¼‰

**é”™è¯¯å¤„ç†ï¼š**
- å¦‚æœæŒ‡çº¹éªŒè¯å¤±è´¥ï¼Œä¼šè¾“å‡º `fingerprint not right`
- å¦‚æœç­¾åéªŒè¯å¤±è´¥ï¼Œä¼šè¾“å‡º `file sig not right`

---

## åŠŸèƒ½éªŒè¯

é¡¹ç›®æä¾›äº†å®Œæ•´çš„æµ‹è¯•è„šæœ¬å’Œç¤ºä¾‹ï¼Œä½äº `test/example/` ç›®å½•ã€‚

### æµ‹è¯•è„šæœ¬è¯´æ˜

#### 1. encode_crate.sh - ç¼–ç æµ‹è¯•

**åŠŸèƒ½ï¼š** ç¼–ç å½“å‰é¡¹ç›®ï¼ˆcrate-specï¼‰ä¸º `.scrate` æ–‡ä»¶

**ä½¿ç”¨æ–¹æ³•ï¼š**
```bash
cd test/example
sh encode_crate.sh
```

**æ‰§è¡Œæµç¨‹ï¼š**
1. ç¼–è¯‘é¡¹ç›®ï¼ˆ`cargo build`ï¼‰
2. è¿è¡Œç¼–ç å‘½ä»¤ï¼Œç”Ÿæˆ `crate-spec-0.1.0.scrate` æ–‡ä»¶
3. è¾“å‡ºæ–‡ä»¶ä¿å­˜åœ¨ `test/output/` ç›®å½•

**è¾“å‡ºï¼š**
- `test/output/crate-spec-0.1.0.scrate`: ç”Ÿæˆçš„ç­¾ååŒ…æ–‡ä»¶

---

#### 2. decode_crate.sh - è§£ç æµ‹è¯•

**åŠŸèƒ½ï¼š** è§£ç  `.scrate` æ–‡ä»¶ï¼ŒéªŒè¯å¹¶æå–åŸå§‹ crate æ–‡ä»¶

**ä½¿ç”¨æ–¹æ³•ï¼š**
```bash
cd test/example
sh decode_crate.sh
```

**å‰ç½®æ¡ä»¶ï¼š**
- éœ€è¦å…ˆè¿è¡Œ `encode_crate.sh` ç”Ÿæˆ `.scrate` æ–‡ä»¶

**æ‰§è¡Œæµç¨‹ï¼š**
1. ç¼–è¯‘é¡¹ç›®ï¼ˆ`cargo build`ï¼‰
2. è¿è¡Œè§£ç å‘½ä»¤ï¼ŒéªŒè¯å¹¶è§£ç  `.scrate` æ–‡ä»¶
3. æå–åŸå§‹ `.crate` æ–‡ä»¶å’Œå…ƒæ•°æ®

**è¾“å‡ºï¼š**
- `test/output/crate-spec-0.1.0.crate`: æå–çš„åŸå§‹ crate æ–‡ä»¶
- `test/output/crate-spec-0.1.0-metadata.txt`: åŒ…å…ƒæ•°æ®æ–‡ä»¶

---

#### 3. hack_file.sh + hack.py - å®Œæ•´æ€§æµ‹è¯•

**åŠŸèƒ½ï¼š** æµ‹è¯•æ–‡ä»¶å®Œæ•´æ€§ä¿æŠ¤æœºåˆ¶ï¼Œæ¨¡æ‹Ÿæ–‡ä»¶æŸåå’Œç¯¡æ”¹åœºæ™¯

**ä½¿ç”¨æ–¹æ³•ï¼š**
```bash
cd test/example
sh hack_file.sh <mode>
```

**å‚æ•°è¯´æ˜ï¼š**
- `mode = 0`: æ¨¡æ‹Ÿæ–‡ä»¶ä¼ è¾“é”™è¯¯ï¼ˆä¿®æ”¹æ–‡ä»¶å­—èŠ‚ï¼‰
- `mode = 1`: æ¨¡æ‹Ÿæ¶æ„ç¯¡æ”¹ï¼ˆä¿®æ”¹æ–‡ä»¶å¹¶é‡ç®—æŒ‡çº¹ï¼‰

---

##### æ¨¡å¼ 0ï¼šæ–‡ä»¶ä¼ è¾“é”™è¯¯æµ‹è¯•

**åœºæ™¯ï¼š** æ¨¡æ‹Ÿåœ¨æ–‡ä»¶ä¼ è¾“è¿‡ç¨‹ä¸­å‘ç”Ÿå­—èŠ‚é”™è¯¯

**æ­¥éª¤ï¼š**
```bash
# 1. é¦–å…ˆç”Ÿæˆ .scrate æ–‡ä»¶
sh encode_crate.sh

# 2. æ¨¡æ‹Ÿä¼ è¾“é”™è¯¯ï¼ˆä¿®æ”¹æ–‡ä»¶ä¸­çš„æŸäº›å­—èŠ‚ï¼‰
sh hack_file.sh 0

# 3. å°è¯•è§£ç ï¼Œåº”è¯¥æ£€æµ‹åˆ°æŒ‡çº¹é”™è¯¯
sh decode_crate.sh
```

**é¢„æœŸç»“æœï¼š**
```
fingerprint not right
```

**åŸç†ï¼š** æ–‡ä»¶æœ«å°¾çš„ SHA256 æŒ‡çº¹ä¸æ–‡ä»¶å†…å®¹ä¸åŒ¹é…ï¼Œå®Œæ•´æ€§æ£€æŸ¥å¤±è´¥ã€‚

---

##### æ¨¡å¼ 1ï¼šæ¶æ„ç¯¡æ”¹æµ‹è¯•

**åœºæ™¯ï¼š** æ¨¡æ‹Ÿæ”»å‡»è€…ä¿®æ”¹æ–‡ä»¶å†…å®¹å¹¶é‡æ–°è®¡ç®—æŒ‡çº¹

**æ­¥éª¤ï¼š**
```bash
# 1. é‡æ–°ç”Ÿæˆ .scrate æ–‡ä»¶
sh encode_crate.sh

# 2. æ¨¡æ‹Ÿæ¶æ„ç¯¡æ”¹ï¼ˆä¿®æ”¹æ–‡ä»¶å†…å®¹å¹¶é‡ç®—æŒ‡çº¹ï¼‰
sh hack_file.sh 1

# 3. å°è¯•è§£ç ï¼Œåº”è¯¥æ£€æµ‹åˆ°ç­¾åé”™è¯¯
sh decode_crate.sh
```

**é¢„æœŸç»“æœï¼š**
```
file sig not right
```

**åŸç†ï¼š** 
- è™½ç„¶æŒ‡çº¹åŒ¹é…ï¼ˆæ”»å‡»è€…é‡ç®—äº†ï¼‰ï¼Œä½†æ–‡ä»¶å†…å®¹è¢«ä¿®æ”¹
- è§£ç æ—¶ä¼šé‡æ–°è®¡ç®—æ‘˜è¦å¹¶ä¸ç­¾åä¸­çš„æ‘˜è¦æ¯”å¯¹
- ç”±äºå†…å®¹è¢«ä¿®æ”¹ï¼Œæ‘˜è¦ä¸åŒ¹é…ï¼Œç­¾åéªŒè¯å¤±è´¥

---

### æµ‹è¯•æ–‡ä»¶ç»“æ„

```
test/
â”œâ”€â”€ example/
â”‚   â”œâ”€â”€ encode_crate.sh    # ç¼–ç æµ‹è¯•è„šæœ¬
â”‚   â”œâ”€â”€ decode_crate.sh    # è§£ç æµ‹è¯•è„šæœ¬
â”‚   â”œâ”€â”€ hack_file.sh       # å®Œæ•´æ€§æµ‹è¯•è„šæœ¬
â”‚   â””â”€â”€ hack.py            # Python è„šæœ¬ï¼ˆç”¨äºä¿®æ”¹æ–‡ä»¶ï¼‰
â”œâ”€â”€ output/                # æµ‹è¯•è¾“å‡ºç›®å½•
â”‚   â”œâ”€â”€ *.scrate           # ç”Ÿæˆçš„ç­¾ååŒ…æ–‡ä»¶
â”‚   â”œâ”€â”€ *.crate            # è§£ç åçš„åŸå§‹åŒ…æ–‡ä»¶
â”‚   â””â”€â”€ *-metadata.txt     # åŒ…å…ƒæ•°æ®æ–‡ä»¶
â”œâ”€â”€ cert.pem               # æµ‹è¯•ç”¨è¯ä¹¦
â”œâ”€â”€ key.pem                # æµ‹è¯•ç”¨ç§é’¥
â””â”€â”€ root-ca.pem            # æµ‹è¯•ç”¨æ ¹CAè¯ä¹¦
```

---

### å®Œæ•´æµ‹è¯•æµç¨‹ç¤ºä¾‹

```bash
# è¿›å…¥æµ‹è¯•ç›®å½•
cd test/example

# 1. ç¼–ç æµ‹è¯•
sh encode_crate.sh
# è¾“å‡º: test/output/crate-spec-0.1.0.scrate

# 2. è§£ç æµ‹è¯•
sh decode_crate.sh
# è¾“å‡º: 
#   - test/output/crate-spec-0.1.0.crate
#   - test/output/crate-spec-0.1.0-metadata.txt

# 3. å®Œæ•´æ€§æµ‹è¯• - ä¼ è¾“é”™è¯¯
sh encode_crate.sh
sh hack_file.sh 0
sh decode_crate.sh
# é¢„æœŸ: fingerprint not right

# 4. å®Œæ•´æ€§æµ‹è¯• - æ¶æ„ç¯¡æ”¹
sh encode_crate.sh
sh hack_file.sh 1
sh decode_crate.sh
# é¢„æœŸ: file sig not right
```

---

### æµ‹è¯•æ³¨æ„äº‹é¡¹

1. **è¯ä¹¦æ–‡ä»¶ï¼š** ç¡®ä¿ `test/` ç›®å½•ä¸‹æœ‰æœ‰æ•ˆçš„è¯ä¹¦æ–‡ä»¶ï¼š
   - `cert.pem`: å‘å¸ƒè€…è¯ä¹¦
   - `key.pem`: å‘å¸ƒè€…ç§é’¥
   - `root-ca.pem`: æ ¹CAè¯ä¹¦

2. **Python ä¾èµ–ï¼š** `hack.py` éœ€è¦ Python 3ï¼Œä½¿ç”¨æ ‡å‡†åº“ï¼Œæ— éœ€é¢å¤–ä¾èµ–

3. **è¾“å‡ºç›®å½•ï¼š** æµ‹è¯•è„šæœ¬ä¼šè‡ªåŠ¨åˆ›å»º `test/output/` ç›®å½•

4. **æ¸…ç†æµ‹è¯•ï¼š** å¦‚éœ€é‡æ–°æµ‹è¯•ï¼Œå¯ä»¥åˆ é™¤ `test/output/` ç›®å½•ä¸­çš„æ–‡ä»¶

---

## å¿«é€Ÿå¯¼èˆª

- [è¿”å›é¡¶éƒ¨](#crate-spec-é¡¹ç›®æ¦‚è§ˆ)
- [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
- [æ ¸å¿ƒæ¨¡å—åˆ†æ](#æ ¸å¿ƒæ¨¡å—åˆ†æ)
- [æ‰§è¡Œæµç¨‹](#æ‰§è¡Œæµç¨‹)
- [å®‰å…¨æœºåˆ¶](#å®‰å…¨æœºåˆ¶)
- [è®¾è®¡ç‰¹ç‚¹](#è®¾è®¡ç‰¹ç‚¹)
- [ä½¿ç”¨è¯´æ˜](#ä½¿ç”¨è¯´æ˜)
- [åŠŸèƒ½éªŒè¯](#åŠŸèƒ½éªŒè¯)

---
