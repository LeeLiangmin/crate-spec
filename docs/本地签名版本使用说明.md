# 本地签名版本使用说明

本项目支持通过配置文件或命令行参数来设置参数，简化重复操作。

## 参数结构

本地签名版本使用以下参数结构：

- `--mode local`：指定为本地模式（默认值，可省略）
- `--config <path>`：指定配置文件路径（默认：`config/config.toml`）
- `--cli`：使用命令行参数模式（仅限 local 模式，与 `--config` 互斥）

## 配置文件格式

默认配置文件为 `config/config.toml`，本地模式使用 `[local.encode]` 和 `[local.decode]` 两个部分：

```toml
[local.encode]
cert_path = "test/cert.pem"
root_ca_path = "test/root-ca.pem"
private_key_path = "test/key.pem"
output_path = "test/output/"
input_path = "../crate-spec"

[local.decode]
root_ca_path = "test/root-ca.pem"
output_path = "test/output/"
input_path = "test/output/crate-spec-0.1.0.scrate"
```

## 使用方法

### 1. 本地模式 + 配置文件（--mode local --config）

使用配置文件进行编码/解码：

```bash
# 编码模式，使用默认配置文件 config/config.toml
cargo run -- -e --mode local --config

# 编码模式，使用自定义配置文件
cargo run -- -e --mode local --config my_config.toml

# 解码模式，使用默认配置文件
cargo run -- -d --mode local --config

# 解码模式，使用自定义配置文件
cargo run -- -d --mode local --config my_config.toml
```

**注意**：由于 `--mode local` 是默认值，`--config` 也有默认值，可以进一步简化：

```bash
# 简化写法（等同于 --mode local --config config/config.toml）
cargo run -- -e --config
cargo run -- -d --config

# 或使用自定义配置文件
cargo run -- -e --config my_config.toml
cargo run -- -d --config my_config.toml
```

### 2. 本地模式 + 命令行参数（--mode local --cli）

使用命令行参数进行编码/解码：

```bash
# 编码模式
cargo run -- -e --mode local --cli -c test/cert.pem -r test/root-ca.pem -p test/key.pem -o test/output/ ../crate-spec

# 解码模式
cargo run -- -d --mode local --cli -r test/root-ca.pem -o test/output/ test/output/crate-spec-0.1.0.scrate
```

**注意**：由于 `--mode local` 是默认值，可以省略：

```bash
# 简化写法（等同于 --mode local --cli）
cargo run -- -e --cli -c test/cert.pem -r test/root-ca.pem -p test/key.pem -o test/output/ ../crate-spec
cargo run -- -d --cli -r test/root-ca.pem -o test/output/ test/output/crate-spec-0.1.0.scrate
```

## 配置项说明

### [local.encode] 部分

| 配置项 | 说明 | 对应命令行参数 |
|--------|------|---------------|
| `cert_path` | 证书文件路径 | `-c` |
| `root_ca_path` | 根CA证书路径 | `-r` |
| `private_key_path` | 私钥文件路径 | `-p` |
| `output_path` | 输出目录路径 | `-o` |
| `input_path` | 输入文件路径 | 位置参数 |

### [local.decode] 部分

| 配置项 | 说明 | 对应命令行参数 |
|--------|------|---------------|
| `root_ca_path` | 根CA证书路径 | `-r` |
| `output_path` | 输出目录路径 | `-o` |
| `input_path` | 输入文件路径 | 位置参数 |

## 重要说明

### 模式选择

**本地模式必须选择 `--config` 或 `--cli` 之一：**

- **`--config`**：程序会**完全**从配置文件中读取所有参数，**忽略所有命令行参数**（除了 `-e`/`-d`、`--mode`、`--config` 本身）
- **`--cli`**：程序会**完全**从命令行参数读取，需要提供所有必需的参数

**`--config` 和 `--cli` 不能同时使用**，必须选择其一。

### 为什么这样设计？

这种设计确保了配置的一致性：
- 使用配置文件时，所有参数都来自同一个配置文件，避免配置混乱
- 使用命令行时，所有参数都明确指定，便于脚本化和自动化

## 示例

### 示例 1: 使用配置文件进行编码

```bash
# 1. 创建 config/config.toml
cat > config/config.toml << EOF
[local.encode]
cert_path = "test/cert.pem"
root_ca_path = "test/root-ca.pem"
private_key_path = "test/key.pem"
output_path = "test/output/"
input_path = "../crate-spec"

[local.decode]
root_ca_path = "test/root-ca.pem"
output_path = "test/output/"
input_path = "test/output/crate-spec-0.1.0.scrate"
EOF

# 2. 运行编码（使用配置文件中的所有参数）
cargo run -- -e --config
# 或完整写法
cargo run -- -e --mode local --config
```

### 示例 2: 使用命令行参数进行编码

```bash
# 不使用配置文件，所有参数通过命令行提供
cargo run -- -e --cli -c test/cert.pem -r test/root-ca.pem -p test/key.pem -o test/output/ ../crate-spec
# 或完整写法
cargo run -- -e --mode local --cli -c test/cert.pem -r test/root-ca.pem -p test/key.pem -o test/output/ ../crate-spec
```

### 示例 3: 使用自定义配置文件

```bash
# 创建自定义配置文件
cat > my_config.toml << EOF
[local.encode]
cert_path = "/path/to/cert.pem"
root_ca_path = "/path/to/root-ca.pem"
private_key_path = "/path/to/key.pem"
output_path = "/tmp/output/"
input_path = "/path/to/crate"
EOF

# 使用自定义配置文件
cargo run -- -e --config my_config.toml
```

## 注意事项

1. **模式参数**：`--mode local` 是默认值，可以省略
2. **配置文件路径**：`--config` 默认值为 `config/config.toml`，可以省略
3. **必须选择**：本地模式必须明确使用 `--config` 或 `--cli`，不能同时使用
4. **配置文件不存在**：如果指定的配置文件不存在，程序会报错并退出
5. **路径解析**：配置文件中的路径可以使用相对路径（相对于当前工作目录）
6. **参数互斥**：使用 `--config` 时，命令行中的其他参数（如 `-c`, `-r`, `-p`, `-o` 等）会被忽略
7. **必需参数**：配置文件必须包含对应模式（`[local.encode]` 或 `[local.decode]`）的所有必需参数
